@using ArandanoIRT.Web._0_Domain.Common
@using ArandanoIRT.Web._0_Domain.Enums
@model IEnumerable<ArandanoIRT.Web._1_Application.DTOs.Plants.PlantStatusHistoryDto>

@{
    ViewData["Title"] = "Historial de Estados de Plantas";
    Layout = "_AdminLayout";
    var maxDate = DateTime.Now.ToString("yyyy-MM-dd");
    var startDateValue = ViewBag.StartDate?.ToString("yyyy-MM-dd");
    var endDateValue = ViewBag.EndDate?.ToString("yyyy-MM-dd");
}

@section Styles {
    <link rel="stylesheet" href="~/css/plantStatus.css" asp-append-version="true"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
}

<div class="page-header">
    <h1>@ViewData["Title"]</h1>
</div>
<p class="lead mb-4">Consulta todos los cambios de estado que han ocurrido en las plantas.</p>

<div class="filter-card">
    <form asp-action="History" method="get">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold">Planta</label>
                <select name="plantId" class="form-select" asp-items="@ViewBag.Plants">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Desde</label>
                <input type="date" name="startDate" class="form-control" value="@startDateValue" max="@maxDate"/>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Hasta</label>
                <input type="date" name="endDate" class="form-control" value="@endDateValue" max="@maxDate"/>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
            </div>
        </div>
    </form>
</div>

<div class="card table-card">
    <div class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>Fecha de Cambio</th>
                <th>Planta</th>
                <th>Estado</th>
                <th>Origen</th>
                <th>Observaci√≥n</th>
            </tr>
            </thead>
            <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@Html.DisplayFor(modelItem => item.ChangedAt)</td>
                        <td>@Html.DisplayFor(modelItem => item.PlantName)</td>
                        <td>
                            @{
                                var statusClass = item.Status switch
                                {
                                    PlantStatus.OPTIMAL => "status-healthy",
                                    PlantStatus.MILD_STRESS => "status-mild-stress",
                                    PlantStatus.SEVERE_STRESS => "status-severe-stress",
                                    PlantStatus.RECOVERING => "status-recovering",
                                    _ => "status-default"
                                };
                            }
                            <span class="status-badge @statusClass">@item.Status.GetDisplayName()</span>
                        </td>
                        <td>@Html.DisplayFor(modelItem => item.Source)</td>
                        <td>@(item.Observation ?? "N/A")</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="5" class="text-center py-4">No hay registros en el historial que coincidan con los
                        filtros.
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>
