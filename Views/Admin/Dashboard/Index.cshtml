@using System.Text.Json
@using ArandanoIRT.Web._0_Domain.Common
@model ArandanoIRT.Web._3_Presentation.ViewModels.SensorData.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard Principal";
    Layout = "_AdminLayout";

    var tempDataJson = Model.TemperatureChartData != null ? JsonSerializer.Serialize(Model.TemperatureChartData) : "null";
    var humDataJson = Model.HumidityChartData != null ? JsonSerializer.Serialize(Model.HumidityChartData) : "null";
    var lightDataJson = Model.LightChartData != null ? JsonSerializer.Serialize(Model.LightChartData) : "null";
}

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true"/>
}

<div class="page-header">
    <h1>@ViewData["Title"]</h1>
    <div class="header-actions">
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse"
                aria-expanded="false" aria-controls="filterCollapse">
            <i class="fas fa-filter"></i> Filtros
        </button>
    </div>
</div>

<div class="collapse" id="filterCollapse">
    <div class="card card-body filter-card mb-4">
        <form asp-action="Index" asp-controller="Dashboard" asp-area="Admin" method="get">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label asp-for="SelectedCropId" class="form-label">Filtrar por Cultivo:</label>
                    <select asp-for="SelectedCropId" asp-items="Model.AvailableCrops" class="form-select"
                            onchange="this.form.submit()">
                    </select>
                </div>
                @if (Model.SelectedCropId.HasValue)
                {
                    <div class="col-md-5">
                        <label asp-for="SelectedPlantId" class="form-label">Filtrar por Planta:</label>
                        <select asp-for="SelectedPlantId" asp-items="Model.AvailablePlants" class="form-select"
                                onchange="this.form.submit()">
                        </select>
                    </div>
                }
                <div class="col-md-2">
                    <a asp-action="Index" asp-controller="Dashboard" asp-area="Admin"
                       class="btn btn-outline-secondary w-100">Limpiar</a>
                </div>
            </div>
        </form>
    </div>
</div>

@* --- Fila de Tarjetas de Resumen Rediseñadas --- *@
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-5 g-4 mb-4">
    <div class="col">
        <div class="kpi-card summary-card">
            <div class="d-flex align-items-center">
                <div class="kpi-icon icon-temp"><i class="fas fa-thermometer-half"></i></div>
                <div class="kpi-content ms-3">
                    <span class="kpi-title" data-bs-toggle="tooltip" title="Temperatura Ambiental">Temperatura Amb.</span>
                    <span class="kpi-value">@(Model.LatestAmbientData?.Temperature.ToString("0.0") ?? "-")°C</span>
                </div>
            </div>
            <div class="summary-details">
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Máximo en las últimas 24 horas">Máx. 24h</span>
                    <span class="detail-value">@(Model.MaxAmbientTemperature24h?.ToString("0.0") ?? "-")°C</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Promedio en las últimas 24 horas">Prom. 24h</span>
                    <span class="detail-value">@(Model.AverageAmbientTemperature24h?.ToString("0.0") ?? "-")°C</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Mínimo en las últimas 24 horas">Mín. 24h</span>
                    <span class="detail-value">@(Model.MinAmbientTemperature24h?.ToString("0.0") ?? "-")°C</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kpi-card summary-card">
            <div class="d-flex align-items-center">
                <div class="kpi-icon icon-humidity"><i class="fas fa-tint"></i></div>
                <div class="kpi-content ms-3">
                    <span class="kpi-title" data-bs-toggle="tooltip" title="Humedad Ambiental">Humedad Amb.</span>
                    <span class="kpi-value">@(Model.LatestAmbientData?.Humidity.ToString("0") ?? "-")%</span>
                </div>
            </div>
            <div class="summary-details">
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Máximo en las últimas 24 horas">Máx. 24h</span>
                    <span class="detail-value">@(Model.MaxAmbientHumidity24h?.ToString("0") ?? "-")%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Promedio en las últimas 24 horas">Prom. 24h</span>
                    <span class="detail-value">@(Model.AverageAmbientHumidity24h?.ToString("0") ?? "-")%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Mínimo en las últimas 24 horas">Mín. 24h</span>
                    <span class="detail-value">@(Model.MinAmbientHumidity24h?.ToString("0") ?? "-")%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kpi-card summary-card">
            <div class="d-flex align-items-center">
                <div class="kpi-icon icon-light"><i class="fas fa-sun"></i></div>
                <div class="kpi-content ms-3">
                    <span class="kpi-title">Luminosidad</span>
                    <span class="kpi-value">@(Model.LatestAmbientData?.Light?.ToString("N0") ?? "-") lx</span>
                </div>
            </div>
            <div class="summary-details">
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Máximo en las últimas 24 horas">Máx. 24h</span>
                    <span class="detail-value">@(Model.MaxAmbientLight24h?.ToString("N0") ?? "-") lx</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Promedio en las últimas 24 horas">Prom. 24h</span>
                    <span class="detail-value">@(Model.AverageAmbientLight24h?.ToString("N0") ?? "-") lx</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Mínimo en las últimas 24 horas">Mín. 24h</span>
                    <span class="detail-value">@(Model.MinAmbientLight24h?.ToString("N0") ?? "-") lx</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kpi-card summary-card">
            <div class="d-flex align-items-center">
                <div class="kpi-icon icon-thermal"><i class="fas fa-fire"></i></div>
                <div class="kpi-content ms-3">
                    <span class="kpi-title" data-bs-toggle="tooltip" title="Temperatura Térmica Promedio">Temp. Térmica</span>
                    <span class="kpi-value">@(Model.ThermalStatistics?.LatestAvgTemp?.ToString("0.0") ?? "-")°C</span>
                </div>
            </div>
            <div class="summary-details">
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Última temperatura térmica más alta">Máx. (última)</span>
                    <span class="detail-value">@(Model.ThermalStatistics?.LatestMaxTemp?.ToString("0.0") ??
                                                   "-")°C</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Última temperatura térmica más baja">Mín. (última)</span>
                    <span class="detail-value">@(Model.ThermalStatistics?.LatestMinTemp?.ToString("0.0") ??
                                                   "-")°C</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Hora Captura</span>
                    <span class="detail-value">@(Model.ThermalStatistics.LatestThermalReadingTimestamp.Value.ToColombiaTime().ToString("HH:mm"))</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kpi-card summary-card">
            <div class="d-flex align-items-center">
                <div class="kpi-icon"><i class="fas fa-satellite-dish"></i></div>
                <div class="kpi-content ms-3">
                    <span class="kpi-title" data-bs-toggle="tooltip" title="Dispositivos Activos">Disp. Activos</span>
                    <span class="kpi-value">@Model.ActiveDevicesCount</span>
                </div>
            </div>
            <div class="summary-details">
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Última Lectura Ambiental">Última Lect. Amb.</span>
                    <span class="detail-value">@(Model.LatestAmbientData.RecordedAt.ToColombiaTime().ToString("HH:mm"))</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label" data-bs-toggle="tooltip" title="Temperatura en la Ciudad">Temp. Ciudad</span>
                    <span class="detail-value">@(Model.LatestAmbientData?.CityTemperature?.ToString("0.0") ??
                                                   "-")°C</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Clima</span>
                    <span class="detail-value" data-bs-toggle="tooltip" data-bs-placement="bottom"
                          title="@(Model.LatestAmbientData?.CityWeatherCondition)">
                    @(Model.LatestAmbientData?.CityWeatherCondition?.Length > 20 ? Model.LatestAmbientData.CityWeatherCondition.Substring(0, 30) + "..." : Model.LatestAmbientData?.CityWeatherCondition ?? "-") </span>
                </div>
            </div>
        </div>
    </div>
</div>


@* Fila de Gráficos (con corrección de altura) *@
<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card chart-card">
            <div class="card-body">
                <h5 class="card-title">Temperatura (°C) - 24h</h5>
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card chart-card">
            <div class="card-body">
                <h5 class="card-title">Humedad (%) - 24h</h5>
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card chart-card">
            <div class="card-body">
                <h5 class="card-title">Luz (lx) - 24h</h5>
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="lightChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card table-card">
            <div class="card-body">
                <h5 class="card-title">Últimas Capturas Térmicas</h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Planta</th>
                            <th>Fecha</th>
                            <th>Temp. Máx</th>
                            <th>Temp. Prom</th>
                            <th>Temp. Mín</th>
                        </tr>
                        </thead>
                        <tbody>
                        @if (Model.RecentCaptures.Any())
                        {
                            @foreach (var capture in Model.RecentCaptures)
                            {
                                <tr>
                                    <td>@capture.PlantName</td>
                                    <td>@Html.DisplayFor(modelItem => capture.RecordedAt)</td>
                                    <td>@capture.MaxTemp?.ToString("0.0")°C</td>
                                    <td>@capture.AvgTemp?.ToString("0.0")°C</td>
                                    <td>@capture.MinTemp?.ToString("0.0")°C</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">No hay capturas térmicas recientes.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script>
        function createTimeSeriesChart(canvasId, chartDataJson, yAxisLabel) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const chartData = JSON.parse(chartDataJson);

            if (!chartData || chartData.Values.length === 0) {
                const context = ctx.getContext('2d');
                context.clearRect(0, 0, ctx.width, ctx.height);
                context.textAlign = 'center';
                context.fillText('No hay datos disponibles.', ctx.width / 2, ctx.height / 2);
                return;
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.Labels,
                    datasets: [{
                        label: chartData.DataSetLabel,
                        data: chartData.Values,
                        borderColor: chartData.BorderColor,
                        backgroundColor: chartData.BackgroundColor,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: false}},
                    scales: {
                        x: {title: {display: false}},
                        y: {title: {display: true, text: yAxisLabel}, beginAtZero: true, min: 0}
                    }
                }
            });
        }
        

        document.addEventListener('DOMContentLoaded', function () {
            createTimeSeriesChart('temperatureChart', '@Html.Raw(tempDataJson)', '°C');
            createTimeSeriesChart('humidityChart', '@Html.Raw(humDataJson)', '%');
            createTimeSeriesChart('lightChart', '@Html.Raw(lightDataJson)', 'lx');
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    </script>
}